#!/bin/bash

# Show help message
show_help() {
    cat << 'EOF'
dfm - Dotfiles Manager

Usage: dfm <command> [arguments...]

Package Management:
  list              List all defined packages
                      -a          List all packages (ignore OS filter)
                      -o <os>     Filter by OS (Darwin, Linux)
                      -s <bool>   Filter by setup status (true/false)
                      -i          Show detailed package info
  check <pkg>       Check if a package is installed
                      -s          Silent mode (exit code only)
  install [pkgs]    Install one or more packages with dependencies
                      -s          Silent mode
                      -y          Skip confirmation prompts
                      -i          Ignore failures, continue installing
  deps <pkg>        Show dependencies for a package
  new <pkg>         Create a new package entry in packages.yaml
                      -d          Also create package directory
                      -f          Also create empty package file

File Management:
  track <pkg> <paths...>    Move files into package dir and symlink back
  link <pkg> <src> <dest>   Create symlink from package file to target
  islinked <pkg> <target>   Check if target is linked to package

Git Operations:
  status            Show git status of dotfiles repository
  diff              Show word diff of dotfiles changes
  pull              Pull latest changes (rebase + autostash)
  push              Stage, commit, and push all changes
  sync              Pull then push (combines both)
  backup            Create a timestamped backup branch

Utilities:
  edit              Open packages.yaml in your editor
  update            Update dfm to latest version
  install-dfm       Install dfm and its dependencies

Options:
  -h, --help        Show this help message

EOF
}

# Check for help flag or no arguments
if [ $# -lt 1 ]; then
    show_help
    exit 1
fi

case "$1" in
    -h|--help|help)
        show_help
        exit 0
        ;;
esac

# Check if the yq command is installed
if ! command -v yq &> /dev/null; then
  echo "Error: 'yq' is not installed. Please run bin/install-dfm to install dependencies."
  exit 1
fi

# Check if the dotfiles dir exists
if ! [ -d "$DFM_DOTFILES" ]; then
    echo "Dotfiles dir '$DFM_DOTFILES' doesn't exist. Please create one and initialize it as a Github repository."
    exit 1
fi

# Check if the YAML file exists
if ! [ -f "$DFM_YAML" ]; then
    echo "Error: DFM_YAML file '$DFM_YAML' doesn't exist. Please create a packages.yaml file in your dotfiles directory."
    exit 1
fi

# Extract the subcommand
subcommand="$1"
shift  # Remove the first argument, leaving any additional arguments

# Build the path to the subcommand script
script_dir=$(dirname "$(realpath "$0")")
subcommand_script=$(realpath "${script_dir}/../scripts/${subcommand}")

# Check if the subcommand script exists and is executable
if [ ! -f "$subcommand_script" ]; then
    echo "Error: Subcommand '$subcommand_script' does not exist."
    exit 1
elif [ ! -x "$subcommand_script" ]; then
    echo "Error: Subcommand '$subcommand_script' is not executable. Please set execute permissions."
    exit 1
fi

# Source the subcommand script and forward the remaining arguments
# Variables declared in this runner script will be available to the sourced subcommand script
export DFM_SUBCOMMAND=true
source "$subcommand_script" "$@"
