#!/bin/bash

if [ -z "$DFM_SUBCOMMAND" ]; then
    echo "Subcommand $0 should be called using 'dfm' command."
    exit 1
fi

# Change to dotfiles directory first so all git operations run in correct location
cd "$DFM_DOTFILES" || { echo "Error: Failed to change to dotfiles directory '$DFM_DOTFILES'"; exit 1; }

if [ -z "$(git status -s)" ]; then
    exit 0
fi

username=$USER
branch_time=$(date '+%Y%m%d%H%M%S')
commit_time=$(date '+%Y/%m/%d %H:%M:%S')
backup_branch="backup_${username}_${branch_time}"
original_branch=$(git branch --show-current)

if ! git checkout -b "$backup_branch"; then
    echo "Error: Failed to create backup branch '$backup_branch'"
    exit 1
fi

if ! git add -A; then
    echo "Error: Failed to stage changes"
    git checkout "$original_branch" 2>/dev/null
    git branch -D "$backup_branch" 2>/dev/null
    exit 1
fi

if ! git commit -m "[Backup] By ${username} on ${commit_time}"; then
    echo "Error: Failed to create backup commit"
    git checkout "$original_branch" 2>/dev/null
    git branch -D "$backup_branch" 2>/dev/null
    exit 1
fi

if ! git push -u origin "$backup_branch"; then
    echo "Error: Failed to push backup branch to remote"
    git checkout "$original_branch" 2>/dev/null
    git branch -D "$backup_branch" 2>/dev/null
    exit 1
fi

if ! git checkout "$original_branch"; then
    echo "Error: Failed to return to original branch '$original_branch'"
    exit 1
fi

git diff .."$backup_branch" | git apply

cd - >/dev/null || exit 1
