#!/bin/bash

if [ -z "$DFM_YES_FLAG" ]; then
    printf "Do you want to install dfm? (y/n): "
    read -r answer

    if [ "$answer" != "y" ]; then
        echo "Installation aborted by the user."
        exit 0
    fi
fi

# Install pre requisites
os_name="$(uname -s)"

case "$os_name" in
    Linux)
        if ! command -v yq &>/dev/null; then
            if ! command -v wget &>/dev/null; then
                echo "Installing wget..."

                if ! (sudo apt-get update && sudo apt-get install -y wget); then
                    echo "Error installing wget. Aborting."
                    exit 1
                fi
            fi

            # Detect architecture for yq download
            arch="$(uname -m)"
            case "$arch" in
                x86_64|amd64)
                    yq_arch="amd64"
                    ;;
                aarch64|arm64)
                    yq_arch="arm64"
                    ;;
                armv7l|armv6l|arm)
                    yq_arch="arm"
                    ;;
                i386|i686)
                    yq_arch="386"
                    ;;
                *)
                    echo "Unsupported architecture: $arch"
                    exit 1
                    ;;
            esac

            echo "Installing yq for $arch..."

            if ! (sudo wget "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_${yq_arch}" -O /usr/local/bin/yq && sudo chmod +x /usr/local/bin/yq); then
                echo "Error installing yq. Aborting."
                exit 1
            fi
        fi
        ;;
    Darwin)
        if ! command -v brew &>/dev/null; then
            echo "Installing Homebrew..."

            if ! (/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"); then
                echo "Error installing Homebrew. Aborting."
                exit 1
            fi
        fi

        if ! command -v yq &>/dev/null; then
            echo "Installing yq..."
            
            if ! (brew install yq); then
                echo "Error installing yq. Aborting."
                exit 1
            fi
        fi


        ;;
    *)
        echo "Unsupported OS: $os_name"
        exit 1
        ;;
esac

# Clone dfm
dfm_dir="$HOME/.dfm"

# Verify git is installed
if ! command -v git &>/dev/null; then
    echo "Error: git is not installed. Please install git first."
    exit 1
fi

if [ ! -d "$dfm_dir" ]; then
    echo "Installing dfm in '$dfm_dir'..."

    if ! (git clone https://github.com/xilixio/df.git "$dfm_dir"); then
        echo "Failed installing dfm. Error: Could not clone the repository."
        exit 1
    fi
fi

# Add dfm/bin to PATH
shell_config_file=""
case "$SHELL" in
    */bash)
        shell_config_file="$HOME/.bashrc"
        ;;
    */zsh)
        shell_config_file="$HOME/.zshrc"
        ;;
    *)
        echo "Unsupported shell. Only bash and zsh are supported."
        exit 1
        ;;
esac

echo "Configuring shell config '$shell_config_file'..."

# Use flock for atomic file operations if available
add_to_shell_config() {
    local pattern="$1"
    local line="$2"

    if ! grep -qF "$pattern" "$shell_config_file" 2>/dev/null; then
        if command -v flock &>/dev/null; then
            flock "$shell_config_file" -c "grep -qF '$pattern' '$shell_config_file' 2>/dev/null || echo '$line' >> '$shell_config_file'"
        else
            echo "$line" >> "$shell_config_file"
        fi
    fi
}

add_to_shell_config "$dfm_dir/bin" "export PATH=\"\$PATH:$dfm_dir/bin\""
add_to_shell_config "export DFM_DOTFILES=" "export DFM_DOTFILES=\"\$HOME/.dotfiles\""
add_to_shell_config "export DFM_YAML=" "export DFM_YAML=\"\$DFM_DOTFILES/packages.yaml\""

# Set up initial gitconfig file if it doesn't exist
gitconfig_file="$HOME/.gitconfig"

if [ ! -f "$gitconfig_file" ]; then
    echo "The .gitconfig file does not exist. Creating one now."

    if [ ! "$DFM_GIT_NAME" ]; then
        read -rp "Enter your name: " name
    else
        name="$DFM_GIT_NAME"
    fi
    
    if [ ! "$DFM_GIT_EMAIL" ]; then
        read -rp "Enter your email: " email
    else
        email="$DFM_GIT_EMAIL"
    fi

    {
        echo "[user]"
        echo "    name = $name"
        echo "    email = $email"
    } > "$gitconfig_file"

    echo ".gitconfig file has been created."
fi

echo ""
echo "Successfully installed dfm. Please reload your shell."